name: Deploy to VPS

on:
    push:
        branches: [main, simple-dev]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Validate required secrets (password auth)
              run: |
                  if [ -z "${{ secrets.DEPLOY_HOST }}" ] || [ -z "${{ secrets.DEPLOY_USER }}" ] || [ -z "${{ secrets.DEPLOY_PASSWORD }}" ] || [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
                    echo "One or more required secrets are missing: DEPLOY_HOST, DEPLOY_USER, DEPLOY_PASSWORD, DEPLOY_PATH"
                    exit 1
                  fi

            - name: Install sshpass for password-based SSH
              run: sudo apt-get update && sudo apt-get install -y sshpass

            - name: Preflight SSH check (password)
              run: |
                  SSH_OPTS=""
                  if [ -n "${{ secrets.DEPLOY_PORT }}" ]; then
                    SSH_OPTS="-p ${{ secrets.DEPLOY_PORT }}"
                  fi
                  if [ -n "${{ secrets.DEPLOY_PORT }}" ]; then
                    echo "Testing SSH connection to ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} on port ${{ secrets.DEPLOY_PORT }}"
                  else
                    echo "Testing SSH connection to ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}"
                  fi
                  sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $SSH_OPTS "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "echo connected" || (echo "SSH preflight failed: check DEPLOY_HOST/DEPLOY_USER and DEPLOY_PASSWORD, and that PasswordAuthentication is enabled on the VPS" && exit 1)

            - name: Setup Node.js (for frontend build)
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Cache frontend node modules
              uses: actions/cache@v4
              with:
                  path: frontend/node_modules
                  key: ${{ runner.os }}-node-${{ hashFiles('frontend/yarn.lock', 'frontend/package.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            - name: Install frontend deps
              working-directory: frontend
              run: yarn install --frozen-lockfile

            - name: Build frontend
              working-directory: frontend
              run: yarn build

            - name: Create tarball
              run: |
                  # Exclude large/runtime artifacts (Solr release folder, venv, node_modules, data files)
                  tar -czf /tmp/repo_deploy.tar.gz \
                    --exclude='.git' \
                    --exclude='.venv' \
                    --exclude='data' \
                    --exclude='frontend/node_modules' \
                    --exclude='solr-*' \
                    --exclude='frontend/.turbo' \
                    .
                  echo "Created /tmp/repo_deploy.tar.gz (size: $(ls -lh /tmp/repo_deploy.tar.gz | awk '{print $5}'))"

            - name: Copy tarball to VPS (password auth)
              run: |
                  set -euo pipefail
                  if [ -n "${{ secrets.DEPLOY_PORT }}" ]; then
                    sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" scp -o StrictHostKeyChecking=no -o ConnectTimeout=10 -P "${{ secrets.DEPLOY_PORT }}" /tmp/repo_deploy.tar.gz "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/repo_deploy.tar.gz"
                  else
                    sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" scp -o StrictHostKeyChecking=no -o ConnectTimeout=10 /tmp/repo_deploy.tar.gz "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/repo_deploy.tar.gz"
                  fi

            - name: Remote extract, install and restart
              run: |
                  set -euo pipefail
                  # compute optional port argument (empty if not provided)
                  PORT_ARG=""
                  if [ -n "${{ secrets.DEPLOY_PORT }}" ]; then
                    PORT_ARG="-p ${{ secrets.DEPLOY_PORT }}"
                  fi

                  # single heredoc invocation (avoids nested heredoc parsing issues)
                  sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $PORT_ARG "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "bash -s" <<'REMOTE'
                    set -euo pipefail
                    echo "Deploying to $DEPLOY_PATH"
                    sudo mkdir -p "$DEPLOY_PATH"
                    sudo tar -xzf /tmp/repo_deploy.tar.gz -C "$DEPLOY_PATH"
                    sudo rm -f /tmp/repo_deploy.tar.gz
                    
                    # Setup Solr
                    echo "=========================================" 
                    echo "Setting up Apache Solr..."
                    echo "========================================="
                    if [ -f "$DEPLOY_PATH/deployment/setup_solr_vps.sh" ]; then
                      sudo chmod +x "$DEPLOY_PATH/deployment/setup_solr_vps.sh"
                      cd "$DEPLOY_PATH/deployment"
                      sudo bash setup_solr_vps.sh
                    else
                      echo "WARNING: Solr setup script not found, skipping Solr setup"
                    fi
                    
                    # Install Python dependencies
                    echo "========================================="
                    echo "Installing Python dependencies..."
                    echo "========================================="
                    if [ ! -d "$DEPLOY_PATH/.venv" ]; then python3 -m venv "$DEPLOY_PATH/.venv"; fi
                    . "$DEPLOY_PATH/.venv/bin/activate"
                    pip install --upgrade pip
                    pip install -r "$DEPLOY_PATH/requirements.txt"
                    
                    # Index data into Solr
                    echo "========================================="
                    echo "Indexing data into Solr..."
                    echo "========================================="
                    # Wait for Solr to be ready
                    for i in {1..30}; do
                      if curl -s "http://localhost:8983/solr/admin/cores?action=STATUS" > /dev/null 2>&1; then
                        echo "Solr is ready"
                        break
                      fi
                      if [ $i -eq 30 ]; then
                        echo "ERROR: Solr is not responding after 30 seconds"
                        exit 1
                      fi
                      sleep 1
                    done
                    
                    # Run indexing
                    cd "$DEPLOY_PATH"
                    python index_data.py || {
                      echo "ERROR: Data indexing failed"
                      exit 1
                    }
                    
                    # Verify indexing
                    DOC_COUNT=$(curl -s "http://localhost:8983/solr/movies/select?q=*:*&rows=0" | grep -oP '"numFound":\K\d+' || echo "0")
                    echo "Indexed documents: $DOC_COUNT"
                    if [ "$DOC_COUNT" -eq 0 ]; then
                      echo "WARNING: No documents were indexed!"
                    fi
                    sudo systemctl restart heritage
                    # trigger the indexer service to rebuild the enriched index (best-effort)
                    # requires the deploy user to have NOPASSWD sudo for starting the unit, otherwise this will be ignored
                    sudo systemctl start heritage-indexer.service || true
                    echo "Remote deploy finished"
                  REMOTE

            - name: Cleanup local tarball
              run: rm -f /tmp/repo_deploy.tar.gz
