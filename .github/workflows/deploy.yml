name: Deploy to VPS

on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Validate required secrets
              run: |
                  if [ -z "${{ secrets.DEPLOY_HOST }}" ] || [ -z "${{ secrets.DEPLOY_USER }}" ] || [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
                    echo "One or more required secrets are missing: DEPLOY_HOST, DEPLOY_USER, SSH_PRIVATE_KEY"
                    echo "Please set them in the repository Settings → Secrets and Variables → Actions"
                    exit 1
                  fi

            - name: Start ssh-agent and add key
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Add host to known_hosts (non-blocking)
              run: |
                  mkdir -p ~/.ssh
                  if [ -n "${{ secrets.DEPLOY_PORT }}" ]; then
                    ssh-keyscan -p "${{ secrets.DEPLOY_PORT }}" -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts || true
                  else
                    ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts || true
                  fi

            - name: Preflight SSH check
              run: |
                  SSH_OPTS=""
                  if [ -n "${{ secrets.DEPLOY_PORT }}" ]; then
                    SSH_OPTS="-p ${{ secrets.DEPLOY_PORT }}"
                  fi
                  echo "Testing SSH connection to ${DEPLOY_USER}@${DEPLOY_HOST} ${DEPLOY_PORT:+on port $DEPLOY_PORT}"
                  ssh -o BatchMode=yes -o ConnectTimeout=10 $SSH_OPTS "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "echo connected" || (echo "SSH preflight failed: check DEPLOY_HOST/DEPLOY_USER, ensure the deploy public key is in ~/.ssh/authorized_keys, and that the host is reachable from GitHub Actions runners" && exit 1)

            - name: Rsync project to VPS (robust)
              run: |
                  set -euo pipefail
                  # Build rsync command with explicit ssh options (avoids prompting). Use a small IO timeout so hung transfers fail fast.
                  if [ -n "${{ secrets.DEPLOY_PORT }}" ]; then
                    SSH_CMD=(ssh -o BatchMode=yes -o ConnectTimeout=10 -p "${{ secrets.DEPLOY_PORT }}")
                  else
                    SSH_CMD=(ssh -o BatchMode=yes -o ConnectTimeout=10)
                  fi
                  RSYNC_OPTS=(rsync -avz --timeout=60 --progress --delete --exclude='.git' --exclude='.venv' --exclude='data')
                  # run rsync via the SSH command built above
                  "${RSYNC_OPTS[@]}" -e "${SSH_CMD[*]}" ./ "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}"

            - name: Remote setup and restart
              run: |
                  set -euo pipefail
                  if [ -n "${{ secrets.DEPLOY_PORT }}" ]; then
                    SSH_OPTS="-p ${{ secrets.DEPLOY_PORT }}"
                  else
                    SSH_OPTS=""
                  fi
                  ssh $SSH_OPTS "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "bash -l -c 'set -euo pipefail; cd "${{ secrets.DEPLOY_PATH }}"; if [ ! -d .venv ]; then python3 -m venv .venv; fi; . .venv/bin/activate; pip install --upgrade pip; pip install -r requirements.txt; sudo systemctl restart heritage'"

            - name: Done
              run: echo "Deployment to ${{ secrets.DEPLOY_HOST }} completed."
